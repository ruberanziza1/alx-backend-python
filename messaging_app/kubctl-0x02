#!/usr/bin/env bash
set -euo pipefail

echo "==> Apply blue/green deployments and services"
kubectl apply -f blue_deployment.yaml
kubectl apply -f green_deployment.yaml
kubectl apply -f kubeservice.yaml

echo "==> Wait for green to be Ready"
kubectl rollout status deploy/messaging-app-green --timeout=180s

GREEN_POD="$(kubectl get pods -l app=messaging-app,version=green -o jsonpath='{.items[0].metadata.name}')"
echo "==> Tail last 50 lines from green pod logs: $GREEN_POD"
kubectl logs "$GREEN_POD" --tail=50 || true

echo "==> Current pods (blue & green)"
kubectl get pods -l app=messaging-app -o wide

cat <<'TIP'

TIP: Gradual traffic shift (simple way)
- Service 'messaging-app' currently selects app=messaging-app (both).
- Increase green replicas and decrease blue to shift traffic:

kubectl scale deploy/messaging-app-green --replicas=3
kubectl scale deploy/messaging-app-blue  --replicas=0

# Or hard switch the service to only green:
kubectl patch svc messaging-app -p '{"spec":{"selector":{"app":"messaging-app","version":"green"}}}'

TIP

